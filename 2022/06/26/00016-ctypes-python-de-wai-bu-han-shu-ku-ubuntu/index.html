<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="00016-ctypes --- Python 的外部函数库, NLP LLM DeepLearning LuYF-Lemon-love 自然语言处理 深度学习 大语言模型">
    <meta name="description" content="前言ctypes 是 Pyhton 的外部函数库。也是 Python 的标准库，因此不需要安装。它提供了与 C 兼容的数据类型，并允许调用 DLL 或共享库中的函数。可以使用该模块以纯 Python 形式对这些库进行封装。
注意：部分示例代">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>00016-ctypes --- Python 的外部函数库 | LuYF-Lemon-love の Blog</title>
    <link rel="icon" type="image/jpeg" href="https://cos.luyf-lemon-love.space/images/苏苏1.jpeg">
    
    <style>
        body{
            background-image: url(https://cos.luyf-lemon-love.space/images/016-%E6%8A%A5%E7%BA%B8%E5%A2%99%E9%BA%BB%E8%A1%A3%E5%AD%A6%E5%A7%90.jpg);
            background-repeat:no-repeat;
            background-size: 100% 100%;
            background-attachment:fixed;
        }
    </style>



    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <span class="logo-span">LuYF-Lemon-love の Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>List</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/galleries">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Image</span>
        </a>
      </li>
      
      <li>
        <a href="/verse">
          
          <i class="fas fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Verse</span>
        </a>
      </li>
      
      <li>
        <a href="/bilibili">
          
          <i class="fas fa-video" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Bilibili</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Server</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="https://luyf-lemon-love.space">
          
          <i class="fas fa-cloud" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Github</span>
        </a>
      </li>
      
      <li>
        <a href="https://server.luyf-lemon-love.space">
          
          <i class="fas fa-cloud" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Cloud</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <div class="logo-name">LuYF-Lemon-love の Blog</div>
        <div class="logo-desc">
            
            天之道，损有余而补不足，人之道则不然，损不足以奉有余。
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			List
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/galleries " style="margin-left:75px">
				  
				   <i class="fa fas fa-image" style="position: absolute;left:50px" ></i>
			      
		          <span>Image</span>
                  </a>
                </li>
              
                <li>

                  <a href="/verse " style="margin-left:75px">
				  
				   <i class="fa fas fa-comments" style="position: absolute;left:50px" ></i>
			      
		          <span>Verse</span>
                  </a>
                </li>
              
                <li>

                  <a href="/bilibili " style="margin-left:75px">
				  
				   <i class="fa fas fa-video" style="position: absolute;left:50px" ></i>
			      
		          <span>Bilibili</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Server
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="https://luyf-lemon-love.space " style="margin-left:75px">
				  
				   <i class="fa fas fa-cloud" style="position: absolute;left:50px" ></i>
			      
		          <span>Github</span>
                  </a>
                </li>
              
                <li>

                  <a href="https://server.luyf-lemon-love.space " style="margin-left:75px">
				  
				   <i class="fa fas fa-cloud" style="position: absolute;left:50px" ></i>
			      
		          <span>Cloud</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/LuYF-Lemon-love/paper-is-all-you-need" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/LuYF-Lemon-love/paper-is-all-you-need" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cos.luyf-lemon-love.space/images/20220604154341.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">00016-ctypes --- Python 的外部函数库</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/C/">
                                <span class="chip bg-color">C++</span>
                            </a>
                        
                            <a href="/tags/Python/">
                                <span class="chip bg-color">Python</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/C-C-%E5%92%8CPython%E6%B7%B7%E5%90%88%E7%BC%96%E7%A8%8B/" class="post-category">
                                C/C++和Python混合编程
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-06-26
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-12-28
                </div>
                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><a href="https://docs.python.org/zh-cn/3/library/ctypes.html#module-ctypes">ctypes</a> 是 Pyhton 的外部函数库。也是 Python 的标准库，因此不需要安装。它提供了与 C 兼容的数据类型，并允许调用 DLL 或共享库中的函数。可以使用该模块以纯 Python 形式对这些库进行封装。</p>
<p>注意：部分示例代码引用了 ctypes 的 c_int 类型。在 sizeof(long) &#x3D;&#x3D; sizeof(int) 的平台上此类型是 c_long 的一个别名。所以，在程序输出 <code>c_long</code> 而不是你期望的 <code>c_int</code> 时，不必感到迷惑 ——— 它们实际上是同一种类型。</p>
<p>本博文的代码在 Linux 版本的 Visual Studio Code 上测试的。</p>
<p>在 VSCode 上配置 C&#x2F;C++ 和 Python 环境，请参考 00008-C-C-和Python多线程初探。</p>
<p>操作系统：Ubuntu 20.04.4 LTS</p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ol>
<li><p><a href="https://docs.python.org/zh-cn/3/library/ctypes.html">ctypes — Python 的外部函数库</a></p>
</li>
<li><p><a href="https://docs.python.org/zh-cn/3/glossary.html#term-global-interpreter-lock">global interpreter lock – 全局解释器锁</a></p>
</li>
<li><p><a href="https://baike.baidu.com/item/%E4%B8%9C%E5%85%AB%E5%8C%BA/8083927">东八区</a></p>
</li>
<li><p><a href="https://blog.csdn.net/weixin_50941322/article/details/111184723?spm=1001.2014.3001.5506">利用time(NULL）函数表示此刻的时间</a></p>
</li>
<li><p><a href="https://cplusplus.com/reference/ctime/time/">time</a></p>
</li>
<li><p><a href="https://cplusplus.com/reference/cstring/strchr/">strchr</a></p>
</li>
<li><p><a href="https://cplusplus.com/reference/cstdio/sscanf/">sscanf</a></p>
</li>
<li><p><a href="https://cplusplus.com/reference/cstdlib/qsort/">qsort</a></p>
</li>
<li><p><a href="https://blog.csdn.net/giveaname/article/details/89811783?spm=1001.2014.3001.5506">Python调用c&#x2F;c++动态库（一）</a></p>
</li>
<li><p><a href="https://cplusplus.com/reference/cstring/strcpy/">strcpy</a></p>
</li>
<li><p><a href="https://cplusplus.com/reference/cstdio/sprintf/">sprintf</a></p>
</li>
</ol>
<h3 id="载入动态链接库"><a href="#载入动态链接库" class="headerlink" title="载入动态链接库"></a>载入动态链接库</h3><ol>
<li>启动 VSCode。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> test_ctypes
<span class="token builtin class-name">cd</span> test_ctypes/
code <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>新建 test_ctypes.c 文件，粘贴下面代码。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">say_hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello world in C.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>生成动态链接库。新建一个终端，输入下面命令。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> libtest.so test_ctypes.c <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="4">
<li>新建 test_ctypes.py 文件，粘贴下面代码。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> ctypes

<span class="token keyword">def</span> <span class="token function">test_say_hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">(</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>say_hello_world <span class="token operator">==</span> libc<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>libc<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span> <span class="token operator">==</span> libc<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    libc_ll <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc_ll<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">(</span><span class="token punctuation">)</span>

    libc_ll<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>libc_ll<span class="token punctuation">.</span>say_hello_world <span class="token operator">==</span> libc_ll<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>libc_ll<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span> <span class="token operator">==</span> libc_ll<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    
    test_say_hello_world<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>配置 Python 的 <code>virtual environment</code> 环境。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python3 <span class="token parameter variable">-m</span> venv .venv
<span class="token builtin class-name">source</span> .venv/bin/activate
python3 <span class="token parameter variable">-m</span> pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pip
deactivate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="6">
<li><p>按 Ctrl+Shift+P，输入 <code>Python: Select Interpreter</code> 命令，选择上步配置的 <code>virtual environment</code> 环境，如 <code>Python 3.9.7 (&#39;.venv&#39;: venv) ./.venv/bin/python	Recommended</code>。</p>
</li>
<li><p>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</p>
</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hello world <span class="token keyword">in</span> C.
hello world <span class="token keyword">in</span> C.
True
False
****************************************************************
hello world <span class="token keyword">in</span> C.
hello world <span class="token keyword">in</span> C.
True
False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ctypes</span><span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span>name<span class="token punctuation">,</span> mode<span class="token operator">=</span>DEFAULT_MODE<span class="token punctuation">,</span> handle<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> use_errno<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> use_last_error<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> winmode<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此类的实例为已加载的动态链接库。库中的函数使用标准 C 调用约定，并假定返回 int 。调用动态库导出的函数之前，Python 会释放 <code>global interpreter lock</code>，并在调用后重新获取。</p>
<p>global interpreter lock – 全局解释器锁</p>
<blockquote>
<p>CPython 解释器所采用的一种机制，它确保同一时刻只有一个线程在执行 Python bytecode。此机制通过防止对象模型（包括 dict 等重要内置类型）的并发访问简化了 CPython 的实现。给整个解释器加锁使得解释器的多线程运行更方便，其代价则是牺牲了在多处理器上的并行性。</p>
<p>不过，某些标准库或第三方库的扩展模块被设计为在执行计算密集型任务如压缩或哈希时释放 GIL。此外，在执行 I&#x2F;O 操作时也总是会释放 GIL。</p>
<p>创建一个（以更精细粒度来锁定共享数据的）“自由线程”解释器的努力从未获得成功，因为这会牺牲在普通单处理器情况下的性能。克服这种性能问题的措施将导致实现变得更复杂，从而更难以维护。</p>
</blockquote>
<hr>
<p>可以使用至少一个参数（共享库的路径名）调用 <code>ctypes.CDLL</code>。也可以传入一个已加载的动态链接库作为 <code>handler</code> 参数，其他情况会调用系统底层的 <code>dlopen</code> 或 <code>LoadLibrary</code> 函数将库加载到进程，并获取其句柄。作为初学者，只需通过 <code>共享库的路径名</code> 即 <code>name</code> 参数来加载动态链接库就可以了。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<p>动态链接库的导出函数可以通过属性或者索引的方式访问。</p>
<ul>
<li><p>通过属性的访问会缓存这个函数，因此每次访问时，返回的都是同一个对象。</p>
</li>
<li><p>通过索引的访问，每次都会返回一个新的对象。</p>
</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">libc<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">(</span><span class="token punctuation">)</span>

libc<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>say_hello_world <span class="token operator">==</span> libc<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>libc<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span> <span class="token operator">==</span> libc<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>共享库也可以通用使用一个预制对象来加载，这种对象是 LibraryLoader 类的实例，具体做法或是通过调用 LoadLibrary() 方法，或是通过将库作为加载器实例的属性来提取。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ctypes</span><span class="token punctuation">.</span>LibraryLoader<span class="token punctuation">(</span>dlltype<span class="token punctuation">)</span>
	
    __getattr__<span class="token punctuation">(</span><span class="token punctuation">)</span>
	
    LoadLibrary<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此类为加载共享库的类。 dlltype 应当为 CDLL, PyDLL, WinDLL 或 OleDLL 类型之一。PyDLL, WinDLL 和 OleDLL 类型与 CDLL 相似，也是用于加载动态链接库的类，由于我们的操作系统是 Linux 和 我们希望调用动态链接库的函数时 Python 会释放 <code>global interpreter lock</code> ，所以这里不介绍 <code>PyDLL</code>、<code>WinDLL</code> 和 <code>OleDLL</code>。</p>
<p><code>__getattr__()</code> 具有特殊的行为：它允许通过将一个共享库作为库加载器实例的属性进行访问来加载它。加载结果将被缓存，因此重复的属性访问，每次都会返回相同的库。</p>
<p><code>LoadLibrary(name)</code> 加载一个共享库到进程中并将其返回。 此方法总是返回一个新的库实例。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">ctypes<span class="token punctuation">.</span>cdll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>ctypes.cdll</code> 是一个 <code>LibraryLoader</code> 类的实例。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">libc_ll <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

libc_ll<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">(</span><span class="token punctuation">)</span>

libc_ll<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>libc_ll<span class="token punctuation">.</span>say_hello_world <span class="token operator">==</span> libc_ll<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>libc_ll<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span> <span class="token operator">==</span> libc_ll<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p><code>ctypes</code> 导出的 <code>cdll</code> 对象，将按<code>标准的 cdecl 调用协议</code>导出函数。</p>
<h3 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h3><p>你可以像调用其他 Python 函数那样调用这些动态链接库中的函数。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>

<span class="token class-name">time_t</span> <span class="token function">time</span> <span class="token punctuation">(</span><span class="token class-name">time_t</span><span class="token operator">*</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>Get the current calendar time as a value of type time_t.</p>
</li>
<li><p>The function returns this value, and if the argument is not a null pointer, it also sets this value to the object pointed by timer.</p>
</li>
<li><p>The value returned generally represents the number of seconds since 00:00 hours, Jan 1, 1970 UTC (i.e., the current unix timestamp). </p>
</li>
<li><p><code>timer</code>: Pointer to an object of type time_t, where the time value is stored. Alternatively, this parameter can be a null pointer, in which case the parameter is not used (the function still returns a value of type time_t with the result).</p>
</li>
<li><p><code>time(NULL)</code>: The value returned represents the number of seconds since 00:00 hours, Jan 1, 1970 UTC (i.e., the current unix timestamp).</p>
</li>
</ul>
<ol>
<li>在 test_ctypes.c 文件中，引用 <code>&lt;time.h&gt;</code> 头文件。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="2">
<li>在 test_ctypes.c 文件中，添加 say_time 函数。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">say_time</span><span class="token punctuation">(</span><span class="token class-name">time_t</span><span class="token operator">*</span> timer<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> now<span class="token punctuation">;</span>

    <span class="token comment">// 今天已经过去的时间（秒）</span>
    now <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">long</span> hour <span class="token operator">=</span> now <span class="token operator">/</span> <span class="token number">3600</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> minute <span class="token operator">=</span> now <span class="token operator">%</span> <span class="token number">3600</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> second <span class="token operator">=</span> now <span class="token operator">%</span> <span class="token number">3600</span> <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"零时区时间： %2ld :%2ld :%2ld \n"</span><span class="token punctuation">,</span> hour<span class="token punctuation">,</span> minute<span class="token punctuation">,</span> second<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 北京位于东八区：东八区（UTC/GMT+08:00）是比世界协调时间（UTC）/格林尼治时间（GMT）快 8 小时的时区</span>
    hour <span class="token operator">=</span> <span class="token punctuation">(</span>hour <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">24</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"北京时间：   %2ld :%2ld :%2ld \n"</span><span class="token punctuation">,</span> hour<span class="token punctuation">,</span> minute<span class="token punctuation">,</span> second<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>生成动态链接库。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> libtest.so test_ctypes.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="4">
<li>在 test_ctypes.py 文件中， 添加 test_say_time 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_say_time</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>say_time<span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>在 <code>if _name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_say_hello_world()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_say_hello_world()</span>

test_say_time<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="6">
<li>打开 test_ctypes.py 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">零时区时间：  <span class="token number">9</span> :16 :43 
北京时间：   <span class="token number">17</span> :16 :43<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在 <code>ctypes</code> 中，调用函数时可以使用 <code>None</code> 作为空指针。</p>
<blockquote>
<p>None, integers, bytes objects and (unicode) strings are the only native Python objects that can directly be used as parameters in these function calls. None is passed as a C NULL pointer, bytes objects and strings are passed as pointer to the memory block that contains their data (char* or wchar_t*). Python integers are passed as the platforms default C int type, their value is masked to fit into the C type.</p>
</blockquote>
<p><code>None</code>, <code>integers</code>, <code>bytes objects</code> 和 <code>(unicode) string</code> 是仅有的可以直接作为函数参数使用的四种 Python 本地数据类型。<code>None</code> 被作为 C 的空指针（NULL）,<code>bytes objects</code> 和 <code>strings</code> 是一个指向其保存数据（char* or wchar_t*）内存块指针，<code>integers</code> 则作为平台默认的 C 的 int 类型，它们的数值被截断以适应 C 类型的整型长度。</p>
<h3 id="基础数据类型"><a href="#基础数据类型" class="headerlink" title="基础数据类型"></a>基础数据类型</h3><p><code>ctypes</code> 定义了一些和 <code>C</code> 兼容的基本数据类型。</p>
<table>
<thead>
<tr>
<th align="center">ctypes type</th>
<th align="center">C type</th>
<th align="center">Python type</th>
</tr>
</thead>
<tbody><tr>
<td align="center">c_bool</td>
<td align="center">_Bool</td>
<td align="center">bool(1)</td>
</tr>
<tr>
<td align="center">c_char</td>
<td align="center">char</td>
<td align="center">1-character bytes object</td>
</tr>
<tr>
<td align="center">c_wchar</td>
<td align="center">wchar_t</td>
<td align="center">1-character string</td>
</tr>
<tr>
<td align="center">c_byte</td>
<td align="center">char</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_ubyte</td>
<td align="center">unsigned char</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_short</td>
<td align="center">short</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_ushort</td>
<td align="center">unsigned short</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_int</td>
<td align="center">int</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_uint</td>
<td align="center">unsigned int</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_long</td>
<td align="center">long</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_ulong</td>
<td align="center">unsigned long</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_longlong</td>
<td align="center">__int64 or long long</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_ulonglong</td>
<td align="center">unsigned __int64 or unsigned long long</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_size_t</td>
<td align="center">size_t</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_ssize_t</td>
<td align="center">ssize_t or Py_ssize_t</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">c_float</td>
<td align="center">float</td>
<td align="center">float</td>
</tr>
<tr>
<td align="center">c_double</td>
<td align="center">double</td>
<td align="center">float</td>
</tr>
<tr>
<td align="center">c_longdouble</td>
<td align="center">long double</td>
<td align="center">float</td>
</tr>
<tr>
<td align="center">c_char_p</td>
<td align="center">char* (NUL terminated)</td>
<td align="center">bytes object or None</td>
</tr>
<tr>
<td align="center">c_wchar_p</td>
<td align="center">wchar_t* (NUL terminated)</td>
<td align="center">string or None</td>
</tr>
<tr>
<td align="center">c_void_p</td>
<td align="center">void*</td>
<td align="center">int or None</td>
</tr>
</tbody></table>
<ol>
<li>在 test_ctypes.py 文件中， 添加 test_say_time 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_fundamental_data_types</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"调用构造函数创建对象："</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_wchar_p<span class="token punctuation">(</span><span class="token string">"Hello, World"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_ushort<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"更改对象的值"</span><span class="token punctuation">)</span>

    i <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    i<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">99</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"c_wchar_p"</span><span class="token punctuation">)</span>

    s <span class="token operator">=</span> <span class="token string">"Hello, World"</span>
    c_s <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_wchar_p<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token comment"># the memory location has changed</span>
    c_s<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">"Hi, there"</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token comment"># first object is unchanged</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"create_string_buffer()"</span><span class="token punctuation">)</span>

    <span class="token comment"># create a 3 byte buffer, initialized to NUL bytes</span>
    p <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># create a buffer containing a NUL terminated string</span>
    p <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token string">b"Hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># create a 10 byte buffer</span>
    p <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token string">b"hello"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">b"Hi"</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>在 <code>if _name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_say_time(None)</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_say_time(None)</span>

test_fundamental_data_types<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>打开 test_ctypes.py 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">调用构造函数创建对象：
c_int<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
c_wchar_p<span class="token punctuation">(</span><span class="token number">139905448734320</span><span class="token punctuation">)</span>
c_ushort<span class="token punctuation">(</span><span class="token number">65533</span><span class="token punctuation">)</span>
****************************************************************
更改对象的值
c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token number">42</span>
<span class="token parameter variable">-99</span>
****************************************************************
c_wchar_p
c_wchar_p<span class="token punctuation">(</span><span class="token number">139905448734320</span><span class="token punctuation">)</span>
Hello, World
c_wchar_p<span class="token punctuation">(</span><span class="token number">139905448740688</span><span class="token punctuation">)</span>
Hi, there
Hello, World
****************************************************************
create_string_buffer<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">3</span> b<span class="token string">'\x00\x00\x00'</span>
<span class="token number">6</span> b<span class="token string">'Hello\x00'</span>
b<span class="token string">'Hello'</span>
<span class="token number">10</span> b<span class="token string">'hello\x00\x00\x00\x00\x00'</span>
<span class="token number">10</span> b<span class="token string">'Hi\x00lo\x00\x00\x00\x00\x00'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<blockquote>
<p>The constructor accepts any object with a truth value.</p>
</blockquote>
<p>使用构造函数创建对象。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"调用构造函数创建对象："</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_wchar_p<span class="token punctuation">(</span><span class="token string">"Hello, World"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_ushort<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>更改对象的值。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"更改对象的值"</span><span class="token punctuation">)</span>

i <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

i<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">99</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当给指针类型的对象 c_char_p、c_wchar_p 和 c_void_p 等赋值时，将改变它们所指向的内存地址，而不是它们所指向的内存区域的内容（这是理所当然的，因为 Python 的 bytes 对象是不可变的）。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"c_wchar_p"</span><span class="token punctuation">)</span>

s <span class="token operator">=</span> <span class="token string">"Hello, World"</span>
c_s <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_wchar_p<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

<span class="token comment"># the memory location has changed</span>
c_s<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">"Hi, there"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

<span class="token comment"># first object is unchanged</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>You should be careful, however, not to pass them to functions expecting pointers to mutable memory. If you need mutable memory blocks, ctypes has a create_string_buffer() function which creates these in various ways. The current memory block contents can be accessed (or changed) with the raw property; if you want to access it as NUL terminated string, use the value property.</p>
</blockquote>
<p>因此，不能将对象 c_char_p、c_wchar_p 和 c_void_p 传递给会改变指针所指内存的函数。如果想要可改变的内存块，可以使用 create_string_buffer() 函数。可以使用 raw 属性存取当前的内存块的内容。如果想要取出 NUL 结束的字符串，需要使用 value 属性。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"create_string_buffer()"</span><span class="token punctuation">)</span>

<span class="token comment"># create a 3 byte buffer, initialized to NUL bytes</span>
p <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># create a buffer containing a NUL terminated string</span>
p <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token string">b"Hello"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># create a 10 byte buffer</span>
p <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token string">b"hello"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">b"Hi"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span>init_or_size<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>This function creates a mutable character buffer. The returned object is a ctypes array of c_char.</p>
<p>init_or_size must be an integer which specifies the size of the array, or a bytes object which will be used to initialize the array items.</p>
<p>If a bytes object is specified as first argument, the buffer is made one item larger than its length so that the last element in the array is a NUL termination character. An integer can be passed as second argument which allows specifying the size of the array if the length of the bytes should not be used.</p>
</blockquote>
<ul>
<li><p>此函数会创建一个可变的字符缓冲区。 返回的对象是一个 c_char 的 ctypes 数组。</p>
</li>
<li><p>init_or_size 必须是一个指明数组大小的整数，或者是一个将被用来初始化数组条目的字节串对象。</p>
</li>
<li><p>如果将一个字节串对象指定为第一个参数，则将使缓冲区大小比其长度多一项以便数组的最后一项为一个 NUL 终结符。 可以传入一个整数作为第二个参数以允许在不使用字节串长度的情况下指定数组大小。</p>
</li>
</ul>
<blockquote>
<p>To create a mutable memory block containing unicode characters of the C type wchar_t use the create_unicode_buffer() function.</p>
</blockquote>
<p>create_unicode_buffer() 函数可以创建 unicode 字符的可变内存块，与之对应的 C 语言类型是 wchar_t。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">ctypes<span class="token punctuation">.</span>create_unicode_buffer<span class="token punctuation">(</span>init_or_size<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>This function creates a mutable unicode character buffer. The returned object is a ctypes array of c_wchar.</p>
<p>init_or_size must be an integer which specifies the size of the array, or a string which will be used to initialize the array items.</p>
<p>If a string is specified as first argument, the buffer is made one item larger than the length of the string so that the last element in the array is a NUL termination character. An integer can be passed as second argument which allows specifying the size of the array if the length of the string should not be used.</p>
</blockquote>
<ul>
<li><p>此函数会创建一个可变的 unicode 字符缓冲区。 返回的对象是一个 c_wchar 的 ctypes 数组。</p>
</li>
<li><p>init_or_size 必须是一个指明数组大小的整数，或者是一个将被用来初始化数组条目的字符串。</p>
</li>
<li><p>如果将一个字符串指定为第一个参数，则将使缓冲区大小比其长度多一项以便数组的最后一项为一个 NUL 终结符。 可以传入一个整数作为第二个参数以允许在不使用字符串长度的情况下指定数组大小。</p>
</li>
</ul>
<h3 id="Calling-functions-continued"><a href="#Calling-functions-continued" class="headerlink" title="Calling functions, continued"></a>Calling functions, continued</h3><ol>
<li>在 <code>test_ctypes.c</code> 文件中，引用 <code>&lt;wchar.h&gt;</code> 头文件。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wchar.h></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="2">
<li>在 <code>test_ctypes.c</code> 文件中，添加 <code>call_functions</code> 函数。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">call_functions</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">,</span> <span class="token class-name">wchar_t</span><span class="token operator">*</span> w_str<span class="token punctuation">,</span> <span class="token keyword">double</span> db<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"int i = %d\nchar* str = %s\nwchar_t* w_str = %ls\ndouble* db = %f\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> str<span class="token punctuation">,</span> w_str<span class="token punctuation">,</span> db<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>生成动态链接库。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> libtest.so test_ctypes.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="4">
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_call_functions</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_call_functions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    i <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>

    <span class="token builtin">str</span> <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">(</span><span class="token string">b"Hello, World in c_char_p."</span><span class="token punctuation">)</span>

    w_str <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_wchar_p<span class="token punctuation">(</span><span class="token string">"我要成为真正的狐狸精!!!"</span><span class="token punctuation">)</span>

    db <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_double<span class="token punctuation">(</span><span class="token number">3.14</span><span class="token punctuation">)</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>call_functions<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">,</span> w_str<span class="token punctuation">,</span> db<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_fundamental_data_types()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_fundamental_data_types()</span>

test_call_functions<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="6">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">int i <span class="token operator">=</span> <span class="token number">42</span>
char* str <span class="token operator">=</span> Hello, World <span class="token keyword">in</span> c_char_p.
wchar_t* w_str <span class="token operator">=</span> 我要成为真正的狐狸精<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
double* db <span class="token operator">=</span> <span class="token number">3.140000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>As has been mentioned before, all Python types except integers, strings, and bytes objects have to be wrapped in their corresponding ctypes type, so that they can be converted to the required C data type</p>
</blockquote>
<p>正如前面所提到过的，除了整数、字符串以及字节串之外，所有的 Python 类型都必须使用它们对应的 ctypes 类型包装，才能够被正确地转换为所需的C语言类型。</p>
<h3 id="使用自定义的数据类型调用函数"><a href="#使用自定义的数据类型调用函数" class="headerlink" title="使用自定义的数据类型调用函数"></a>使用自定义的数据类型调用函数</h3><ol>
<li>在 <code>test_ctypes.c</code> 文件中，添加 <code>say_bottles</code> 函数。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">say_bottles</span><span class="token punctuation">(</span><span class="token keyword">int</span> bottles<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d bottles of beer.\n"</span><span class="token punctuation">,</span> bottles<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>生成动态链接库。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> libtest.so test_ctypes.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="3">
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_say_bottles</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Bottles</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        self<span class="token punctuation">.</span>_as_parameter_ <span class="token operator">=</span> number

<span class="token keyword">def</span> <span class="token function">test_say_bottles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    bottles <span class="token operator">=</span> Bottles<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>say_bottles<span class="token punctuation">(</span>bottles<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_call_functions()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_call_functions()</span>

test_say_bottles<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">42</span> bottles of beer.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>You can also customize ctypes argument conversion to allow instances of your own classes be used as function arguments. ctypes looks for an <em>as_parameter</em> attribute and uses this as the function argument. Of course, it must be one of integer, string, or bytes</p>
</blockquote>
<p>你也可以通过自定义 ctypes 参数转换方式来允许自定义类型作为参数。ctypes 会寻找 <em>as_parameter</em> 属性并使用它作为函数参数。当然，它必须是数字、字符串或者二进制字符串。</p>
<h3 id="指定必选参数的类型（函数原型）"><a href="#指定必选参数的类型（函数原型）" class="headerlink" title="指定必选参数的类型（函数原型）"></a>指定必选参数的类型（函数原型）</h3><ol>
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_argtypes</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_argtypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>call_functions<span class="token punctuation">.</span>argtypes <span class="token operator">=</span> <span class="token punctuation">[</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_wchar_p<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_double<span class="token punctuation">]</span>

    libc<span class="token punctuation">.</span>call_functions<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">b"Hello, World in c_char_p."</span><span class="token punctuation">,</span> <span class="token string">"我要成为真正的狐狸精!!!"</span><span class="token punctuation">,</span> <span class="token number">3.14</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_say_bottles()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_say_bottles()</span>

test_argtypes<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">int i <span class="token operator">=</span> <span class="token number">42</span>
char* str <span class="token operator">=</span> Hello, World <span class="token keyword">in</span> c_char_p.
wchar_t* w_str <span class="token operator">=</span> 我要成为真正的狐狸精<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
double* db <span class="token operator">=</span> <span class="token number">3.140000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>It is possible to specify the required argument types of functions exported from DLLs by setting the argtypes attribute.</p>
<p>argtypes must be a sequence of C data types.</p>
<p>Specifying a format protects against incompatible argument types (just as a prototype for a C function), and tries to convert the arguments to valid types.</p>
</blockquote>
<ul>
<li><p>可以通过设置 argtypes 属性指定从 DLL 中导出函数的必选参数类型。</p>
</li>
<li><p>argtypes 必须是一个 C 数据类型的序列。</p>
</li>
<li><p>指定数据类型可以防止不合理的参数传递（就像 C 函数的原型），并且会自动尝试将参数转换为需要的类型。</p>
</li>
</ul>
<h3 id="返回类型"><a href="#返回类型" class="headerlink" title="返回类型"></a>返回类型</h3><ol>
<li>在 <code>test_ctypes.c</code> 文件中，引用 <code>&lt;string.h&gt;</code> 头文件。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="2">
<li>在 <code>test_ctypes.c</code> 文件中，添加 <code>return_bool</code> 函数。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">return_bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>生成动态链接库。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> libtest.so test_ctypes.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="4">
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>valid_return</code> 和 <code>test_return_types</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">valid_return</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token keyword">def</span> <span class="token function">test_return_types</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
    strchr <span class="token operator">=</span> libc<span class="token punctuation">.</span>strchr
    <span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># c_char_p is a pointer to a string</span>
    strchr<span class="token punctuation">.</span>restype <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_char_p
    <span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    strchr<span class="token punctuation">.</span>argtypes <span class="token operator">=</span> <span class="token punctuation">[</span>ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_char<span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token string">b"d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token string">b"x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    return_bool <span class="token operator">=</span> libc<span class="token punctuation">.</span>return_bool
    return_bool<span class="token punctuation">.</span>restype <span class="token operator">=</span> valid_return

    <span class="token keyword">print</span><span class="token punctuation">(</span>return_bool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_argtypes()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_argtypes()</span>

test_return_types<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="6">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-1173963645</span>
b<span class="token string">'def'</span>
None
****************************************************************
b<span class="token string">'def'</span>
None
****************************************************************
True<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">strchr</span> <span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> str<span class="token punctuation">,</span> <span class="token keyword">int</span> character <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">strchr</span> <span class="token punctuation">(</span> <span class="token keyword">char</span> <span class="token operator">*</span> str<span class="token punctuation">,</span> <span class="token keyword">int</span> character <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Locate first occurrence of character in string</strong></p>
<p>Returns a pointer to the first occurrence of character in the C string str.</p>
<p>The terminating null-character is considered part of the C string. Therefore, it can also be located in order to retrieve a pointer to the end of a string.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><p><code>str</code>: C string.</p>
</li>
<li><p><code>character</code>: Character to be located. It is passed as its int promotion, but it is internally converted back to char for the comparison.</p>
</li>
</ul>
<p><strong>Return Value</strong></p>
<p>A pointer to the first occurrence of character in str. If the character is not found, the function returns a null pointer.</p>
<p><strong>Portability</strong></p>
<p>In C, this function is only declared as:</p>
<p><code>char * strchr ( const char *, int );</code></p>
<p>instead of the two overloaded versions provided in C++.</p>
<hr>
<blockquote>
<p>By default functions are assumed to return the C int type. Other return types can be specified by setting the restype attribute of the function object.</p>
</blockquote>
<p>默认情况下都会假定函数返回 C int 类型。其他返回类型可以通过设置函数对象的 restype 属性来指定。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
strchr <span class="token operator">=</span> libc<span class="token punctuation">.</span>strchr
<span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># c_char_p is a pointer to a string</span>
strchr<span class="token punctuation">.</span>restype <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_char_p
<span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>If you want to avoid the ord(“x”) calls above, you can set the argtypes attribute, and the second argument will be converted from a single character Python bytes object into a C char.</p>
</blockquote>
<p>如果希望避免上述的 ord(“x”) 调用，可以设置 argtypes 属性，第二个参数就会将单字符的 Python 二进制字符对象转换为 C 字符。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">strchr<span class="token punctuation">.</span>argtypes <span class="token operator">=</span> <span class="token punctuation">[</span>ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_char<span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token string">b"d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token string">b"x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>You can also use a callable Python object (a function or a class for example) as the restype attribute, if the foreign function returns an integer. The callable will be called with the integer the C function returns, and the result of this call will be used as the result of your function call. This is useful to check for error return values and automatically raise an exception.</p>
</blockquote>
<p>如果外部函数返回了一个整数，你也可以使用一个可调用的 Python 对象（比如函数或者类）作为 restype 属性的值。将会以 C 函数返回的整数对象作为参数调用这个可调用对象，执行后的结果作为最终函数返回值。这在错误返回值校验和自动抛出异常等方面比较有用。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">valid_return</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
        
return_bool <span class="token operator">=</span> libc<span class="token punctuation">.</span>return_bool
return_bool<span class="token punctuation">.</span>restype <span class="token operator">=</span> valid_return

<span class="token keyword">print</span><span class="token punctuation">(</span>return_bool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="传递指针（或以引用方式传递形参）"><a href="#传递指针（或以引用方式传递形参）" class="headerlink" title="传递指针（或以引用方式传递形参）"></a>传递指针（或以引用方式传递形参）</h3><ol>
<li>在 <code>test_ctypes.c</code> 文件中，引用 <code>&lt;stdio.h&gt;</code> 头文件。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="2">
<li>在 <code>test_ctypes.c</code> 文件中，添加 <code>pass_pointers</code> 函数。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">pass_pointers</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> i<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> f<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">sscanf</span><span class="token punctuation">(</span><span class="token string">"1 3.14 Hello"</span><span class="token punctuation">,</span> <span class="token string">"%d %f %s"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> f<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>生成动态链接库。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> libtest.so test_ctypes.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="4">
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_pass_pointers</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_pass_pointers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    i <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_float<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token string">b'\000'</span> <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">,</span> f<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>pass_pointers<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">,</span> f<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_return_types()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_return_types()</span>

test_pass_pointers<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="6">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">0</span> <span class="token number">0.0</span> b<span class="token string">''</span>
<span class="token number">1</span> <span class="token number">3.140000104904175</span> b<span class="token string">'Hello'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">sscanf</span> <span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> s<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>Read formatted data from string</strong></p>
<p>Reads data from s and stores them according to parameter format into the locations given by the additional arguments, as if scanf was used, but reading from s instead of the standard input (stdin).</p>
<p>The additional arguments should point to already allocated objects of the type specified by their corresponding format specifier within the format string.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><p><code>s</code>: C string that the function processes as its source to retrieve the data.</p>
</li>
<li><p><code>format</code>: C string that contains a format string that follows the same specifications as format in scanf (see scanf for details).</p>
</li>
<li><p><code>... (additional arguments)</code>: Depending on the format string, the function may expect a sequence of additional arguments, each containing a pointer to allocated storage where the interpretation of the extracted characters is stored with the appropriate type. There should be at least as many of these arguments as the number of values stored by the format specifiers. Additional arguments are ignored by the function.</p>
</li>
</ul>
<p><strong>Return Value</strong></p>
<p>On success, the function returns the number of items in the argument list successfully filled. This count can match the expected number of items or be less (even zero) in the case of a matching failure. In the case of an input failure before any data could be successfully interpreted, EOF is returned.</p>
<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token punctuation">,</span> offset<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Returns a light-weight pointer to obj, which must be an instance of a ctypes type. offset defaults to zero, and must be an integer that will be added to the internal pointer value.</p>
<p>byref(obj, offset) corresponds to this C code:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>obj<span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The returned object can only be used as a foreign function call parameter. It behaves similar to pointer(obj), but the construction is a lot faster.</p>
<hr>
<blockquote>
<p>Sometimes a C api function expects a pointer to a data type as parameter, probably to write into the corresponding location, or if the data is too large to be passed by value. This is also known as passing parameters by reference.</p>
</blockquote>
<p>有时候 C 函数接口可能由于要往某个地址写入值，或者数据太大不适合作为值传递，从而希望接收一个指针作为数据参数类型。这可以称为引用方式传递形参。</p>
<blockquote>
<p>ctypes exports the byref() function which is used to pass parameters by reference. The same effect can be achieved with the pointer() function, although pointer() does a lot more work since it constructs a real pointer object, so it is faster to use byref() if you don’t need the pointer object in Python itself.</p>
</blockquote>
<p>ctypes 暴露了 byref() 函数用于通过引用传递参数，使用 pointer() 函数也能达到同样的效果，只不过 pointer() 需要更多步骤，因为它要先构造一个真实指针对象。所以在 Python 代码本身不需要使用这个指针对象的情况下，使用 byref() 效率更高。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">pass_pointers</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> i<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> f<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">sscanf</span><span class="token punctuation">(</span><span class="token string">"1 3.14 Hello"</span><span class="token punctuation">,</span> <span class="token string">"%d %f %s"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> f<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_pass_pointers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    i <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_float<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token string">b'\000'</span> <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">,</span> f<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>pass_pointers<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">,</span> f<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Structures-and-unions"><a href="#Structures-and-unions" class="headerlink" title="Structures and unions"></a>Structures and unions</h3><ol>
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_structures_unions</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">POINT</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">RECT</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"upperleft"</span><span class="token punctuation">,</span> POINT<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"lowerright"</span><span class="token punctuation">,</span> POINT<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_structures_unions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    p_1 <span class="token operator">=</span> POINT<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>p_1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p_1<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    p_2 <span class="token operator">=</span> POINT<span class="token punctuation">(</span>y <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>p_2<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p_2<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    rc <span class="token operator">=</span> RECT<span class="token punctuation">(</span>p_1<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    rc_1 <span class="token operator">=</span> RECT<span class="token punctuation">(</span>POINT<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> POINT<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    rc_2 <span class="token operator">=</span> RECT<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>rc_1<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_1<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc_1<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_1<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>rc_2<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_2<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc_2<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_2<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>POINT<span class="token punctuation">.</span>x<span class="token punctuation">,</span> POINT<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_pass_pointers()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_pass_pointers()</span>

test_structures_unions<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">10</span> <span class="token number">20</span>
<span class="token number">0</span> <span class="token number">5</span>
****************************************************************
<span class="token number">10</span> <span class="token number">20</span> <span class="token number">0</span> <span class="token number">0</span>
****************************************************************
<span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span>
<span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span>
****************************************************************
<span class="token operator">&lt;</span>Field <span class="token assign-left variable">type</span><span class="token operator">=</span>c_int, <span class="token assign-left variable">ofs</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token operator"><span class="token file-descriptor important">4</span>></span> <span class="token operator">&lt;</span>Field <span class="token assign-left variable">type</span><span class="token operator">=</span>c_int, <span class="token assign-left variable">ofs</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token operator"><span class="token file-descriptor important">4</span>></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<blockquote>
<p>Structures and unions must derive from the Structure and Union base classes which are defined in the ctypes module. Each subclass must define a <em>fields</em> attribute. <em>fields</em> must be a list of 2-tuples, containing a field name and a field type.</p>
</blockquote>
<p>结构体和联合必须继承自 ctypes 模块中的 Structure 和 Union 。子类必须定义 <em>fields</em> 属性。 <em>fields</em> 是一个二元组列表，二元组中包含 field name 和 field type 。</p>
<blockquote>
<p>The field type must be a ctypes type like c_int, or any other derived ctypes type: structure, union, array, pointer.</p>
</blockquote>
<p>type 字段必须是一个 ctypes 类型，比如 c_int，或者其他 ctypes 类型: 结构体、联合、数组、指针。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">POINT</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">]</span>
    
p_1 <span class="token operator">=</span> POINT<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>p_1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p_1<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

p_2 <span class="token operator">=</span> POINT<span class="token punctuation">(</span>y <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>p_2<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p_2<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">RECT</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"upperleft"</span><span class="token punctuation">,</span> POINT<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"lowerright"</span><span class="token punctuation">,</span> POINT<span class="token punctuation">)</span><span class="token punctuation">]</span>

rc <span class="token operator">=</span> RECT<span class="token punctuation">(</span>p_1<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>Nested structures can also be initialized in the constructor in several ways.</p>
</blockquote>
<p>嵌套结构体可以通过几种方式构造初始化。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">rc_1 <span class="token operator">=</span> RECT<span class="token punctuation">(</span>POINT<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> POINT<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
rc_2 <span class="token operator">=</span> RECT<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>rc_1<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_1<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc_1<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_1<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>rc_2<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_2<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc_2<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_2<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>Field descriptors can be retrieved from the class, they are useful for debugging because they can provide useful information.</p>
</blockquote>
<p>可以通过类获取字段 descriptor，它能提供很多有用的调试信息。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>POINT<span class="token punctuation">.</span>x<span class="token punctuation">,</span> POINT<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<p>ctypes does not support passing unions or structures with bit-fields to functions by value. While this may work on 32-bit x86, it’s not guaranteed by the library to work in the general case. Unions and structures with bit-fields should always be passed to functions by pointer.</p>
<hr>
<p>ctypes 不支持带位域的结构体、联合以值的方式传给函数。这可能在 32 位 x86 平台上可以正常工作，但是对于一般情况，这种行为是未定义的。带位域的结构体、联合应该总是通过指针传递给函数。</p>
<h3 id="Bit-fields-in-structures-and-unions"><a href="#Bit-fields-in-structures-and-unions" class="headerlink" title="Bit fields in structures and unions"></a>Bit fields in structures and unions</h3><ol>
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_bit_fields</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Int</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"first_16"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"second_16"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_bit_fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>Int<span class="token punctuation">.</span>first_16<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>Int<span class="token punctuation">.</span>second_16<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_structures_unions()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_structures_unions()</span>

test_bit_fields<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>Field <span class="token assign-left variable">type</span><span class="token operator">=</span>c_int, <span class="token assign-left variable">ofs</span><span class="token operator">=</span><span class="token number">0</span>:0, <span class="token assign-left variable">bits</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator"><span class="token file-descriptor important">6</span>></span>
<span class="token operator">&lt;</span>Field <span class="token assign-left variable">type</span><span class="token operator">=</span>c_int, <span class="token assign-left variable">ofs</span><span class="token operator">=</span><span class="token number">0</span>:16, <span class="token assign-left variable">bits</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator"><span class="token file-descriptor important">6</span>></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<hr>
<blockquote>
<p>It is possible to create structures and unions containing bit fields. Bit fields are only possible for integer fields, the bit width is specified as the third item in the <code>_fields_</code> tuples.</p>
</blockquote>
<p>结构体和联合中是可以包含位域字段的。位域只能用于整型字段，位长度通过 <em>fields</em> 中的第三个参数指定。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Int</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"first_16"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"second_16"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_bit_fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>Int<span class="token punctuation">.</span>first_16<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>Int<span class="token punctuation">.</span>second_16<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Arrays"><a href="#Arrays" class="headerlink" title="Arrays"></a>Arrays</h3><ol>
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_arrays</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MyStruct</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_float<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"point_array"</span><span class="token punctuation">,</span> POINT <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_arrays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    TenPointsArrayType <span class="token operator">=</span> POINT <span class="token operator">*</span> <span class="token number">10</span>

    arr <span class="token operator">=</span> TenPointsArrayType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> pt <span class="token keyword">in</span> arr<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>pt<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pt<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>point_array<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    TenIntegers <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> <span class="token number">10</span>

    ii <span class="token operator">=</span> TenIntegers<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> ii<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_bit_fields()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_bit_fields()</span>

test_arrays<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">0</span> <span class="token number">0</span>
<span class="token number">0</span> <span class="token number">0</span>
<span class="token number">0</span> <span class="token number">0</span>
<span class="token number">0</span> <span class="token number">0</span>
<span class="token number">0</span> <span class="token number">0</span>
<span class="token number">0</span> <span class="token number">0</span>
<span class="token number">0</span> <span class="token number">0</span>
<span class="token number">0</span> <span class="token number">0</span>
<span class="token number">0</span> <span class="token number">0</span>
<span class="token number">0</span> <span class="token number">0</span>
****************************************************************
<span class="token number">4</span>
****************************************************************
<span class="token operator">&lt;</span>__main__.c_int_Array_10 object at 0x7f22efcbedc<span class="token operator"><span class="token file-descriptor important">0</span>></span>
<span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<blockquote>
<p>Arrays are sequences, containing a fixed number of instances of the same type.</p>
<p>The recommended way to create array types is by multiplying a data type with a positive integer.</p>
</blockquote>
<p>数组是一个序列，包含指定个数元素，且必须类型相同。创建数组类型的推荐方式是使用一个类型乘以一个正数。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">TenPointsArrayType <span class="token operator">=</span> POINT <span class="token operator">*</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MyStruct</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_float<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"point_array"</span><span class="token punctuation">,</span> POINT <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>point_array<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">arr <span class="token operator">=</span> TenPointsArrayType<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> pt <span class="token keyword">in</span> arr<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pt<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pt<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>Initializers of the correct type can also be specified.</p>
</blockquote>
<p>也能通过指定正确类型的数据来初始化。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">TenIntegers <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> <span class="token number">10</span>

ii <span class="token operator">=</span> TenIntegers<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> ii<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Pointers"><a href="#Pointers" class="headerlink" title="Pointers"></a>Pointers</h3><ol>
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_pointers</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_pointers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    i <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
    pi <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>i<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents <span class="token keyword">is</span> i<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents <span class="token keyword">is</span> pi<span class="token punctuation">.</span>contents<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    j <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span>
    pi<span class="token punctuation">.</span>contents <span class="token operator">=</span> j
    <span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
    pi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">22</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    PI <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>PI<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>PI<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    null_ptr <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">(</span>null_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_arrays()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_arrays()</span>

test_pointers<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">****************************************************************
c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
****************************************************************
False
False
****************************************************************
c_int<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span>
****************************************************************
<span class="token number">99</span>
****************************************************************
c_int<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span>
c_int<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span>
****************************************************************
<span class="token operator">&lt;</span>class <span class="token string">'__main__.LP_c_int'</span><span class="token operator">></span>
<span class="token operator">&lt;</span>__main__.LP_c_int object at 0x7f354fbb724<span class="token operator"><span class="token file-descriptor important">0</span>></span>
****************************************************************
False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>This factory function creates and returns a new ctypes pointer type. Pointer types are cached and reused internally, so calling this function repeatedly is cheap. type must be a ctypes type.</p>
<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>This function creates a new pointer instance, pointing to obj. The returned object is of the type POINTER(type(obj)).</p>
<p>Note: If you just want to pass a pointer to an object to a foreign function call, you should use byref(obj) which is much faster.</p>
<hr>
<blockquote>
<p>Pointer instances are created by calling the pointer() function on a ctypes type.</p>
</blockquote>
<p>可以将 ctypes 类型数据传入 pointer() 函数创建指针。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">i <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
pi <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>Pointer instances have a contents attribute which returns the object to which the pointer points, the i object above.</p>
</blockquote>
<p>指针实例拥有 contents 属性，它返回指针指向的真实对象，如上面的 i 对象。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>Note that ctypes does not have OOR (original object return), it constructs a new, equivalent object each time you retrieve an attribute.</p>
</blockquote>
<p>注意 ctypes 并没有 OOR（返回原始对象），每次访问这个属性时都会构造返回一个新的相同对象。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents <span class="token keyword">is</span> i<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents <span class="token keyword">is</span> pi<span class="token punctuation">.</span>contents<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>Assigning another c_int instance to the pointer’s contents attribute would cause the pointer to point to the memory location where this is stored.</p>
</blockquote>
<p>将这个指针的 contents 属性赋值为另一个 c_int 实例将会导致该指针指向该实例的内存地址。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">j <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span>
pi<span class="token punctuation">.</span>contents <span class="token operator">=</span> j
<span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>Pointer instances can also be indexed with integers.</p>
</blockquote>
<p>指针对象也可以通过整数下标进行访问。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>Assigning to an integer index changes the pointed to value.</p>
</blockquote>
<p>通过整数下标赋值可以改变指针所指向的真实内容。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
pi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">22</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>It is also possible to use indexes different from 0, but you must know what you’re doing, just as in C: You can access or change arbitrary memory locations. Generally you only use this feature if you receive a pointer from a C function, and you know that the pointer actually points to an array instead of a single item.</p>
</blockquote>
<p>使用 0 以外的索引也是合法的，但是你必须确保知道自己为什么这么做，就像 C 语言中: 你可以访问或者修改任意内存内容。通常只会在函数接收指针是才会使用这种特性，而且你知道这个指针指向的是一个数组而不是单个值。</p>
<blockquote>
<p>Behind the scenes, the pointer() function does more than simply create pointer instances, it has to create pointer types first. This is done with the POINTER() function, which accepts any ctypes type, and returns a new type.</p>
</blockquote>
<p>内部细节，pointer() 函数不只是创建了一个指针实例，它首先创建了一个指针类型。这是通过调用 POINTER() 函数实现的，它接收 ctypes 类型为参数，返回一个新的类型。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">PI <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>PI<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>PI<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>Calling the pointer type without an argument creates a NULL pointer. NULL pointers have a False boolean value.</p>
</blockquote>
<p>无参调用指针类型可以创建一个 NULL 指针。 NULL 指针的布尔值是 False。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">null_ptr <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">(</span>null_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>ctypes checks for NULL when dereferencing pointers (but dereferencing invalid non-NULL pointers would crash Python).</p>
</blockquote>
<p>解引用指针的时候， ctypes 会帮你检测是否指针为 NULL (但是解引用无效的非 NULL 指针仍会导致 Python 崩溃)</p>
<h3 id="Type-conversions"><a href="#Type-conversions" class="headerlink" title="Type conversions"></a>Type conversions</h3><ol>
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_type_conversions</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"values"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_type_conversions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    bar <span class="token operator">=</span> Bar<span class="token punctuation">(</span><span class="token punctuation">)</span>
    bar<span class="token punctuation">.</span>values <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    bar<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">3</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    bar<span class="token punctuation">.</span>values <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    a <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_byte <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>a<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    bar <span class="token operator">=</span> Bar<span class="token punctuation">(</span><span class="token punctuation">)</span>
    b <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_long <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
    bar<span class="token punctuation">.</span>values <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>b<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_pointers()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_pointers()</span>

test_type_conversions<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
****************************************************************
****************************************************************
<span class="token operator">&lt;</span>__main__.LP_c_int object at 0x7ff94fca744<span class="token operator"><span class="token file-descriptor important">0</span>></span>
****************************************************************
<span class="token number">97</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">ctypes<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>This function is similar to the cast operator in C. It returns a new instance of type which points to the same memory block as obj. type must be a pointer type, and obj must be an object that can be interpreted as a pointer.</p>
<hr>
<blockquote>
<p>Usually, ctypes does strict type checking. This means, if you have POINTER(c_int) in the argtypes list of a function or as the type of a member field in a structure definition, only instances of exactly the same type are accepted. There are some exceptions to this rule, where ctypes accepts other objects. For example, you can pass compatible array instances instead of pointer types. So, for POINTER(c_int), ctypes accepts an array of c_int.</p>
</blockquote>
<p>通常情况下，ctypes 具有严格的类型检查。这代表着，如果在函数 argtypes 中或者结构体定义成员中有 POINTER(c_int) 类型，只有相同类型的实例才会被接受。也有一些例外。比如，你可以传递兼容的数组实例给指针类型。所以，对于 POINTER(c_int)，ctypes 也可以接受 c_int 类型的数组。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"values"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

bar <span class="token operator">=</span> Bar<span class="token punctuation">(</span><span class="token punctuation">)</span>
bar<span class="token punctuation">.</span>values <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
bar<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">3</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>In addition, if a function argument is explicitly declared to be a pointer type (such as POINTER(c_int)) in argtypes, an object of the pointed type (c_int in this case) can be passed to the function. ctypes will apply the required byref() conversion in this case automatically.</p>
</blockquote>
<p>另外，如果一个函数 argtypes 列表中的参数显式的定义为指针类型(如 POINTER(c_int) )，指针所指向的类型 (这个例子中是 c_int ) 也可以传递给函数。ctypes 会自动调用对应的 byref() 转换。</p>
<blockquote>
<p>To set a POINTER type field to NULL, you can assign None.</p>
</blockquote>
<p>可以给指针内容赋值为 None 将其设置为 Null。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">bar<span class="token punctuation">.</span>values <span class="token operator">=</span> <span class="token boolean">None</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>The cast() function can be used to cast a ctypes instance into a pointer to a different ctypes data type. cast() takes two parameters, a ctypes object that is or can be converted to a pointer of some kind, and a ctypes pointer type. It returns an instance of the second argument, which references the same memory block as the first argument.</p>
</blockquote>
<p>cast() 函数可以将一个指针实例强制转换为另一种 ctypes 类型。cast() 接收两个参数，一个 ctypes 指针对象或者可以被转换为指针的其他类型对象，和一个 ctypes 指针类型。返回第二个类型的一个实例，该返回实例和第一个参数指向同一片内存空间。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">a <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_byte <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>a<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>So, cast() can be used to assign to the values field of Bar the structure.</p>
</blockquote>
<p>所以 cast() 可以用来给结构体 Bar 的 values 字段赋值。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">bar <span class="token operator">=</span> Bar<span class="token punctuation">(</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_long <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
bar<span class="token punctuation">.</span>values <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>b<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Incomplete-Types"><a href="#Incomplete-Types" class="headerlink" title="Incomplete Types"></a>Incomplete Types</h3><ol>
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_incomplete_types</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">cell</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">pass</span>

cell<span class="token punctuation">.</span>_fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"next"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_incomplete_types</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    c1 <span class="token operator">=</span> cell<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">b"foo"</span>
    
    c2 <span class="token operator">=</span> cell<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c2<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">b"bar"</span>

    c1<span class="token punctuation">.</span><span class="token builtin">next</span> <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>c2<span class="token punctuation">)</span>
    c2<span class="token punctuation">.</span><span class="token builtin">next</span> <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>c1<span class="token punctuation">)</span>

    p<span class="token operator">=</span>c1
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
        p <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_type_conversions()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_type_conversions()</span>

test_incomplete_types<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">b<span class="token string">'foo'</span> b<span class="token string">'bar'</span> b<span class="token string">'foo'</span> b<span class="token string">'bar'</span> b<span class="token string">'foo'</span> b<span class="token string">'bar'</span> b<span class="token string">'foo'</span> b<span class="token string">'bar'</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<blockquote>
<p>Incomplete Types are structures, unions or arrays whose members are not yet specified. In C, they are specified by forward declarations, which are defined later.</p>
</blockquote>
<p>不完整类型即还没有定义成员的结构体、联合或者数组。在 C 中，它们通常用于前置声明，然后在后面定义。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">cell</span><span class="token punctuation">;</span> <span class="token comment">/* forward declaration */</span>

<span class="token keyword">struct</span> <span class="token class-name">cell</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">cell</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>翻译成 ctypes 代码。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">cell</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">pass</span>

cell<span class="token punctuation">.</span>_fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"next"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>We create two instances of cell, and let them point to each other, and finally follow the pointer chain a few times.</p>
</blockquote>
<p>我们定义两个 cell 实例，让它们互相指向对方，然后通过指针链式访问几次。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_incomplete_types</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    c1 <span class="token operator">=</span> cell<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">b"foo"</span>
    
    c2 <span class="token operator">=</span> cell<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c2<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">b"bar"</span>

    c1<span class="token punctuation">.</span><span class="token builtin">next</span> <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>c2<span class="token punctuation">)</span>
    c2<span class="token punctuation">.</span><span class="token builtin">next</span> <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>c1<span class="token punctuation">)</span>

    p<span class="token operator">=</span>c1
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
        p <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Callback-functions"><a href="#Callback-functions" class="headerlink" title="Callback functions"></a>Callback functions</h3><ol>
<li>在 <code>test_ctypes.c</code> 文件中，引用 <code>&lt;stdlib.h&gt;</code> 头文件。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="2">
<li>生成动态链接库。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> libtest.so test_ctypes.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="3">
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>py_cmp_func</code>、<code>py_cmp_reverse</code> 和 <code>test_callback_functions</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">py_cmp_func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"py_cmp_func"</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token decorator annotation punctuation">@ctypes<span class="token punctuation">.</span>CFUNCTYPE</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">py_cmp_reverse</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"py_cmp_reverse"</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_callback_functions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    IntArray5 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> <span class="token number">5</span>
    ia <span class="token operator">=</span> IntArray5<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
    qsort <span class="token operator">=</span> libc<span class="token punctuation">.</span>qsort
    qsort<span class="token punctuation">.</span>restype <span class="token operator">=</span> <span class="token boolean">None</span>

    CMPFUNC <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CFUNCTYPE<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span>
    qsort<span class="token punctuation">(</span>ia<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ia<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> CMPFUNC<span class="token punctuation">(</span>py_cmp_func<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> ia<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    ia_r <span class="token operator">=</span> IntArray5<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>
    qsort<span class="token punctuation">(</span>ia_r<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ia_r<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> py_cmp_reverse<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> ia_r<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_incomplete_types()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_incomplete_types()</span>

test_callback_functions<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">py_cmp_func <span class="token number">5</span> <span class="token number">1</span>
py_cmp_func <span class="token number">33</span> <span class="token number">99</span>
py_cmp_func <span class="token number">7</span> <span class="token number">33</span>
py_cmp_func <span class="token number">1</span> <span class="token number">7</span>
py_cmp_func <span class="token number">5</span> <span class="token number">7</span>
<span class="token number">1</span> <span class="token number">5</span> <span class="token number">7</span> <span class="token number">33</span> <span class="token number">99</span> 
****************************************************************
py_cmp_reverse <span class="token number">5</span> <span class="token number">1</span>
py_cmp_reverse <span class="token number">33</span> <span class="token number">99</span>
py_cmp_reverse <span class="token number">7</span> <span class="token number">99</span>
py_cmp_reverse <span class="token number">7</span> <span class="token number">33</span>
py_cmp_reverse <span class="token number">5</span> <span class="token number">99</span>
py_cmp_reverse <span class="token number">5</span> <span class="token number">33</span>
py_cmp_reverse <span class="token number">5</span> <span class="token number">7</span>
<span class="token number">99</span> <span class="token number">33</span> <span class="token number">7</span> <span class="token number">5</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">void</span> <span class="token function">qsort</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> base<span class="token punctuation">,</span> <span class="token class-name">size_t</span> num<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>compar<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>Sort elements of array</strong></p>
<p>Sorts the num elements of the array pointed to by base, each element size bytes long, using the compar function to determine the order.</p>
<p>The sorting algorithm used by this function compares pairs of elements by calling the specified compar function with pointers to them as argument.</p>
<p>The function does not return any value, but modifies the content of the array pointed to by base reordering its elements as defined by compar.</p>
<p>The order of equivalent elements is undefined.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><p><code>base</code>: Pointer to the first object of the array to be sorted, converted to a void*.</p>
</li>
<li><p><code>num</code>: Number of elements in the array pointed to by base. size_t is an unsigned integral type.</p>
</li>
<li><p><code>size</code>: Size in bytes of each element in the array. size_t is an unsigned integral type.</p>
</li>
<li><p><code>compar</code>: </p>
<p> Pointer to a function that compares two elements. This function is called repeatedly by qsort to compare two elements. It shall follow the following prototype:</p>
 <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">compar</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> p1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p> Taking two pointers as arguments (both converted to const void*). The function defines the order of the elements by returning (in a stable and transitive manner):</p>
<table>
<thead>
<tr>
<th align="center">return value</th>
<th align="center">meaning</th>
</tr>
</thead>
<tbody><tr>
<td align="center">&lt;0</td>
<td align="center">The element pointed to by p1 goes before the element pointed to by p2</td>
</tr>
<tr>
<td align="center">0</td>
<td align="center">The element pointed to by p1 is equivalent to the element pointed to by p2</td>
</tr>
<tr>
<td align="center">&gt;0</td>
<td align="center">The element pointed to by p1 goes after the element pointed to by p2</td>
</tr>
</tbody></table>
<p> For types that can be compared using regular relational operators, a general compar function may look like:</p>
 <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">compareMyType</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> a<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>MyType<span class="token operator">*</span><span class="token punctuation">)</span>a <span class="token operator">&lt;</span>  <span class="token operator">*</span><span class="token punctuation">(</span>MyType<span class="token operator">*</span><span class="token punctuation">)</span>b <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>MyType<span class="token operator">*</span><span class="token punctuation">)</span>a <span class="token operator">==</span> <span class="token operator">*</span><span class="token punctuation">(</span>MyType<span class="token operator">*</span><span class="token punctuation">)</span>b <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>MyType<span class="token operator">*</span><span class="token punctuation">)</span>a <span class="token operator">></span>  <span class="token operator">*</span><span class="token punctuation">(</span>MyType<span class="token operator">*</span><span class="token punctuation">)</span>b <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p><strong>Return Value</strong></p>
<p>none</p>
<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">ctypes<span class="token punctuation">.</span>CFUNCTYPE<span class="token punctuation">(</span>restype<span class="token punctuation">,</span> <span class="token operator">*</span>argtypes<span class="token punctuation">,</span> use_errno<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> use_last_error<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The returned function prototype creates functions that use the standard C calling convention. The function will release the GIL during the call. </p>
<hr>
<blockquote>
<p>ctypes allows creating C callable function pointers from Python callables. These are sometimes called callback functions.</p>
</blockquote>
<p>ctypes 允许创建一个指向 Python 可调用对象的 C 函数。它们有时候被称为回调函数。</p>
<blockquote>
<p>First, you must create a class for the callback function. The class knows the calling convention, the return type, and the number and types of arguments this function will receive. The CFUNCTYPE() factory function creates types for callback functions using the cdecl calling convention.</p>
</blockquote>
<p>首先，你必须为回调函数创建一个类，这个类知道调用约定，包括返回值类型以及函数接收的参数类型及个数。CFUNCTYPE() 工厂函数使用 cdecl 调用约定创建回调函数类型。</p>
<blockquote>
<p>Both of these factory functions are called with the result type as first argument, and the callback functions expected argument types as the remaining arguments.</p>
<p>I will present an example here which uses the standard C library’s qsort() function, that is used to sort items with the help of a callback function. qsort() will be used to sort an array of integers.</p>
</blockquote>
<p>这些工厂函数的第一个参数是返回值类型，回调函数的参数类型作为剩余参数。这里展示一个使用 C 标准库函数 qsort() 的例子，它使用一个回调函数对数据进行排序。qsort() 将用来给整数数组排序。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">IntArray5 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> <span class="token number">5</span>
ia <span class="token operator">=</span> IntArray5<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>

libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
qsort <span class="token operator">=</span> libc<span class="token punctuation">.</span>qsort
qsort<span class="token punctuation">.</span>restype <span class="token operator">=</span> <span class="token boolean">None</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>qsort() must be called with a pointer to the data to sort, the number of items in the data array, the size of one item, and a pointer to the comparison function, the callback. The callback will then be called with two pointers to items, and it must return a negative integer if the first item is smaller than the second, a zero if they are equal, and a positive integer otherwise.</p>
</blockquote>
<p>qsort() 必须接收的参数，一个指向待排序数据的指针，元素个数，每个元素的大小，以及一个指向排序函数的指针，即回调函数。然后回调函数接收两个元素的指针，如果第一个元素小于第二个，则返回一个负整数，如果相等则返回 0，否则返回一个正整数。</p>
<blockquote>
<p>So our callback function receives pointers to integers, and must return an integer. First we create the type for the callback function.</p>
</blockquote>
<p>所以，我们的回调函数要接收两个整数指针，返回一个整数。首先我们创建回调函数的类型。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">CMPFUNC <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CFUNCTYPE<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>Now we can actually compare the two items and return a useful result.</p>
</blockquote>
<p>现在我们可以比较两个元素并返回有用的结果了。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">py_cmp_func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"py_cmp_func"</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

qsort<span class="token punctuation">(</span>ia<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ia<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> CMPFUNC<span class="token punctuation">(</span>py_cmp_func<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>As we can easily check, our array is sorted now.</p>
</blockquote>
<p>我们可以轻易地验证，现在数组是有序的了。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> ia<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>The function factories can be used as decorator factories, so we may as well write.</p>
</blockquote>
<p>这些工厂函数可以当作装饰器工厂，所以可以这样写。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@ctypes<span class="token punctuation">.</span>CFUNCTYPE</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">py_cmp_reverse</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"py_cmp_reverse"</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

ia_r <span class="token operator">=</span> IntArray5<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>
qsort<span class="token punctuation">(</span>ia_r<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ia_r<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> py_cmp_reverse<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> ia_r<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Accessing-values-exported-from-dlls"><a href="#Accessing-values-exported-from-dlls" class="headerlink" title="Accessing values exported from dlls"></a>Accessing values exported from dlls</h3><ol>
<li>在 <code>test_ctypes.c</code> 文件中，添加 <code>NUMBER</code> 常量和 <code>array</code> 数组。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">int</span> NUMBER <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">int</span> array<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>生成动态链接库。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> libtest.so test_ctypes.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="3">
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_access_values_from_dlls</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_access_values_from_dlls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
    num <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">.</span>in_dll<span class="token punctuation">(</span>libc<span class="token punctuation">,</span> <span class="token string">"NUMBER"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    array <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> num<span class="token punctuation">.</span>value
    table <span class="token operator">=</span> array<span class="token punctuation">.</span>in_dll<span class="token punctuation">(</span>libc<span class="token punctuation">,</span> <span class="token string">"array"</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> item <span class="token keyword">in</span> table<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_callback_functions()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_callback_functions()</span>

test_access_values_from_dlls<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">c_int<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token number">10</span>
****************************************************************
<span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> 
****************************************************************
<span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ctypes</span><span class="token punctuation">.</span>_CData
    <span class="token comment"># This non-public class is the common base class of all ctypes data types.</span>
    
    in_dll<span class="token punctuation">(</span>library<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token comment"># This method returns a ctypes type instance exported by a shared library. name is the name of the symbol that exports the data, library is the loaded shared library.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<blockquote>
<p>Some shared libraries not only export functions, they also export variables. ctypes can access values like this with the in_dll() class methods of the type.</p>
</blockquote>
<p>一些动态链接库不仅仅可以导出函数，也会导出变量。ctypes 可以通过 in_dll() 类方法访问这类变量。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">int</span> NUMBER <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
num <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">.</span>in_dll<span class="token punctuation">(</span>libc<span class="token punctuation">,</span> <span class="token string">"NUMBER"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>访问数组。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">int</span> array<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">array <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> num<span class="token punctuation">.</span>value
table <span class="token operator">=</span> array<span class="token punctuation">.</span>in_dll<span class="token punctuation">(</span>libc<span class="token punctuation">,</span> <span class="token string">"array"</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> item <span class="token keyword">in</span> table<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Surprises"><a href="#Surprises" class="headerlink" title="Surprises"></a>Surprises</h3><ol>
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_surprises</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_surprises</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    p1 <span class="token operator">=</span> POINT<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    p2 <span class="token operator">=</span> POINT<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    rc <span class="token operator">=</span> RECT<span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token comment"># now swap the two points</span>
    rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright <span class="token operator">=</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft
    <span class="token keyword">print</span><span class="token punctuation">(</span>rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    s <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">b"abc def ghi"</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value <span class="token keyword">is</span> s<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_access_values_from_dlls()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_access_values_from_dlls()</span>

test_surprises<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span>
<span class="token number">3</span> <span class="token number">4</span> <span class="token number">3</span> <span class="token number">4</span>
****************************************************************
b<span class="token string">'abc def ghi'</span>
False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<blockquote>
<p>There are some edges in ctypes where you might expect something other than what actually happens.</p>
</blockquote>
<p>ctypes 也有自己的边界，有时候会发生一些意想不到的事情。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">p1 <span class="token operator">=</span> POINT<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
p2 <span class="token operator">=</span> POINT<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
rc <span class="token operator">=</span> RECT<span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

<span class="token comment"># now swap the two points</span>
rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright <span class="token operator">=</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft
<span class="token keyword">print</span><span class="token punctuation">(</span>rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>Hm. We certainly expected the last statement to print 3 4 1 2. What happened? Here are the steps of the rc.a, rc.b &#x3D; rc.b, rc.a line above.</p>
</blockquote>
<p>嗯。我们预想应该打印 <code>3 4 1 2</code> 。但是为什么呢? 这是 <code>rc.a, rc.b = rc.b, rc.a</code> 这行代码展开后的步骤。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">temp0<span class="token punctuation">,</span> temp1 <span class="token operator">=</span> rc<span class="token punctuation">.</span>b<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>a
rc<span class="token punctuation">.</span>a <span class="token operator">=</span> temp0
rc<span class="token punctuation">.</span>b <span class="token operator">=</span> temp1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>Note that temp0 and temp1 are objects still using the internal buffer of the rc object above. So executing rc.a &#x3D; temp0 copies the buffer contents of temp0 into rc ‘s buffer. This, in turn, changes the contents of temp1. So, the last assignment rc.b &#x3D; temp1, doesn’t have the expected effect.</p>
</blockquote>
<p>注意 temp0 和 temp1 对象始终引用了对象 rc 的内容。然后执行 rc.a &#x3D; temp0 会把 temp0 的内容拷贝到 rc 的空间。这也改变了 temp1 的内容。最终导致赋值语句 rc.b &#x3D; temp1 没有产生预想的效果。</p>
<blockquote>
<p>Keep in mind that retrieving sub-objects from Structure, Unions, and Arrays doesn’t copy the sub-object, instead it retrieves a wrapper object accessing the root-object’s underlying buffer.</p>
</blockquote>
<p>记住，访问被包含在结构体、联合、数组中的对象并不会将其复制出来，而是得到了一个代理对象，它是对根对象的内部内容的一层包装。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">s <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">(</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">b"abc def ghi"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value <span class="token keyword">is</span> s<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用 c_char_p  实例化的对象只能将其值设置为 bytes 或者整数。</p>
<blockquote>
<p>Why is it printing False? ctypes instances are objects containing a memory block plus some descriptors accessing the contents of the memory. Storing a Python object in the memory block does not store the object itself, instead the contents of the object is stored. Accessing the contents again constructs a new Python object each time!</p>
</blockquote>
<p>为什么这里打印了 False ？ctypes 实例是一些内存块加上一些用于访问这些内存块的 descriptor 组成。将 Python 对象存储在内存块并不会存储对象本身，而是存储了对象的内容。每次访问对象的内容都会构造一个新的 Python 对象。</p>
<h3 id="Variable-sized-data-types"><a href="#Variable-sized-data-types" class="headerlink" title="Variable-sized data types"></a>Variable-sized data types</h3><ol>
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_variable_sized_data_types</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_variable_sized_data_types</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    short_array <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_short <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    ctypes<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>short_array<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>short_array<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_surprises()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_surprises()</span>

test_variable_sized_data_types<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">8</span>
<span class="token number">8</span>
<span class="token number">32</span>
<span class="token number">8</span>
<span class="token punctuation">[</span><span class="token number">0</span>, <span class="token number">0</span>, <span class="token number">0</span>, <span class="token number">0</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">ctypes<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>This function resizes the internal memory buffer of obj, which must be an instance of a ctypes type. It is not possible to make the buffer smaller than the native size of the objects type, as given by sizeof(type(obj)), but it is possible to enlarge the buffer.</p>
<hr>
<blockquote>
<p>ctypes provides some support for variable-sized arrays and structures.</p>
</blockquote>
<p>ctypes 对变长数组和结构体提供了一些支持。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_variable_sized_data_types</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    short_array <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_short <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    ctypes<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>short_array<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>short_array<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="from-buffer-copy"><a href="#from-buffer-copy" class="headerlink" title="from_buffer_copy"></a>from_buffer_copy</h3><ol>
<li>在 <code>test_ctypes.c</code> 文件中，添加 <code>say_array</code> 函数。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">say_array</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>puStr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c "</span><span class="token punctuation">,</span> puStr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>生成动态链接库。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> libtest.so test_ctypes.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="3">
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_from_buffer_copy</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_from_buffer_copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
    u_str_info <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_ubyte <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span>from_buffer_copy<span class="token punctuation">(</span><span class="token string">b'0123456789abcdef'</span><span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>say_array<span class="token punctuation">(</span>u_str_info<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_variable_sized_data_types()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_variable_sized_data_types()</span>

test_from_buffer_copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ctypes</span><span class="token punctuation">.</span>_CData
    <span class="token comment"># This non-public class is the common base class of all ctypes data types. </span>
    
    from_buffer_copy<span class="token punctuation">(</span>source<span class="token punctuation">[</span><span class="token punctuation">,</span> offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># This method creates a ctypes instance, copying the buffer from the source object buffer which must be readable. The optional offset parameter specifies an offset into the source buffer in bytes; the default is zero.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="二级指针"><a href="#二级指针" class="headerlink" title="二级指针"></a>二级指针</h3><ol>
<li>在 <code>test_ctypes.c</code> 文件中，引用 <code>&lt;string.h&gt;</code> 头文件。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="2">
<li>在 <code>test_ctypes.c</code> 文件中，添加 <code>double_point</code> 和 <code>free_point</code> 函数。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">double_point</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span> ppInt<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> ppStr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"before int: %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>ppInt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token operator">*</span>ppInt <span class="token operator">=</span> <span class="token number">10086</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>ppStr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token operator">*</span>ppStr<span class="token punctuation">,</span> <span class="token string">"Happy National Day!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">free_point</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pt<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pt <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>生成动态链接库。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> libtest.so test_ctypes.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="4">
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_double_point</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test_double_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    int_a <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    int_pt <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>int_a<span class="token punctuation">)</span>
    word_pt <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    libc<span class="token punctuation">.</span>double_point<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>int_pt<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>word_pt<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"out_value: "</span><span class="token punctuation">,</span> int_a<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"out_word: "</span><span class="token punctuation">,</span> word_pt<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>free_point<span class="token punctuation">(</span>word_pt<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_from_buffer_copy()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_from_buffer_copy()</span>

test_double_point<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="6">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">before int: <span class="token number">10</span>
out_value:  <span class="token number">10086</span>
out_word:  b<span class="token string">'Happy National Day!'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">strcpy</span> <span class="token punctuation">(</span> <span class="token keyword">char</span> <span class="token operator">*</span> destination<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> source <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>Copy string</strong></p>
<p>Copies the C string pointed by source into the array pointed by destination, including the terminating null character (and stopping at that point).</p>
<p>To avoid overflows, the size of the array pointed by destination shall be long enough to contain the same C string as source (including the terminating null character), and should not overlap in memory with source.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><p><code>destination</code>: Pointer to the destination array where the content is to be copied.</p>
</li>
<li><p><code>source</code>: C string to be copied.</p>
</li>
</ul>
<p><strong>Return Value</strong></p>
<p>destination is returned.</p>
<h3 id="结构体综合练习"><a href="#结构体综合练习" class="headerlink" title="结构体综合练习"></a>结构体综合练习</h3><ol>
<li>在 <code>test_ctypes.c</code> 文件中，添加下面代码。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_rect</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> index<span class="token punctuation">;</span>
    <span class="token keyword">char</span> info<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>Rect<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">read_rect</span><span class="token punctuation">(</span>Rect rect<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index: %d info: %s\n"</span><span class="token punctuation">,</span> rect<span class="token punctuation">.</span>index<span class="token punctuation">,</span> rect<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">read_rect_point</span><span class="token punctuation">(</span>Rect <span class="token operator">*</span> pRect<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index: %d info: %s\n"</span><span class="token punctuation">,</span> pRect<span class="token operator">-></span>index<span class="token punctuation">,</span> pRect<span class="token operator">-></span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">read_rect_array</span><span class="token punctuation">(</span>Rect <span class="token operator">*</span> pRectArray<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pRectArray.index: %d pRectArray.info: %s\n"</span><span class="token punctuation">,</span> pRectArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">,</span> pRectArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

Rect <span class="token operator">*</span> <span class="token function">obtain_rect_array</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span> pArrayNum<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>pArrayNum <span class="token operator">=</span> num<span class="token punctuation">;</span>
    Rect <span class="token operator">*</span>pArray <span class="token operator">=</span> <span class="token punctuation">(</span>Rect<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>num <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Rect<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        pArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>index <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>pArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>info<span class="token punctuation">,</span> <span class="token string">"%s_%d"</span><span class="token punctuation">,</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> pArray<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">free_rect</span><span class="token punctuation">(</span>Rect <span class="token operator">*</span> pRect<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>pRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>生成动态链接库。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> libtest.so test_ctypes.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="3">
<li>在 <code>test_ctypes.py</code> 文件中，添加 <code>test_read_rect</code> 函数。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_char <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_read_rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    rect_a <span class="token operator">=</span> Rect<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">b"Hello"</span><span class="token punctuation">)</span>
    
    libc<span class="token punctuation">.</span>read_rect<span class="token punctuation">(</span>rect_a<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>read_rect_point<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>rect_a<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    rect_array <span class="token operator">=</span> <span class="token punctuation">(</span>Rect <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        rect_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Rect<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token string">"Hello_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>read_rect_array<span class="token punctuation">(</span>rect_array<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>obtain_rect_array<span class="token punctuation">.</span>restype <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>Rect<span class="token punctuation">)</span>
    num <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rect_pt <span class="token operator">=</span> libc<span class="token punctuation">.</span>obtain_rect_array<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">,</span> rect_pt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">,</span> <span class="token string">"info: "</span><span class="token punctuation">,</span> rect_pt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>info<span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>free_rect<span class="token punctuation">(</span>rect_pt<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li>在 <code>if __name__ == &#39;__main__&#39;:</code> 中，注释 <code>test_double_point()</code>。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#test_double_point()</span>

test_read_rect<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>打开 <code>test_ctypes.py</code> 文件，点击右上角的 <code>Run Python File</code> 按钮，运行 Python 脚本。</li>
</ol>
<p>output</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">index: <span class="token number">10</span> info: Hello
****************************************************************
index: <span class="token number">10</span> info: Hello
****************************************************************
pRectArray.index: <span class="token number">0</span> pRectArray.info: Hello_0
pRectArray.index: <span class="token number">1</span> pRectArray.info: Hello_1
pRectArray.index: <span class="token number">2</span> pRectArray.info: Hello_2
pRectArray.index: <span class="token number">3</span> pRectArray.info: Hello_3
pRectArray.index: <span class="token number">4</span> pRectArray.info: Hello_4
****************************************************************
index:  <span class="token number">0</span> info:  b<span class="token string">'Hello_0'</span>
index:  <span class="token number">1</span> info:  b<span class="token string">'Hello_1'</span>
index:  <span class="token number">2</span> info:  b<span class="token string">'Hello_2'</span>
index:  <span class="token number">3</span> info:  b<span class="token string">'Hello_3'</span>
index:  <span class="token number">4</span> info:  b<span class="token string">'Hello_4'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">sprintf</span> <span class="token punctuation">(</span> <span class="token keyword">char</span> <span class="token operator">*</span> str<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>Write formatted data to string</strong></p>
<p>Composes a string with the same text that would be printed if format was used on printf, but instead of being printed, the content is stored as a C string in the buffer pointed by str.</p>
<p>The size of the buffer should be large enough to contain the entire resulting string (see snprintf for a safer version).</p>
<p>A terminating null character is automatically appended after the content.</p>
<p>After the format parameter, the function expects at least as many additional arguments as needed for format.</p>
<p><strong>Parameters</strong></p>
<ul>
<li><p><code>str</code>: Pointer to a buffer where the resulting C-string is stored. The buffer should be large enough to contain the resulting string.</p>
</li>
<li><p><code>format</code>: C string that contains a format string that follows the same specifications as format in printf (see printf for details).</p>
</li>
<li><p><code>... (additional arguments)</code>: Depending on the format string, the function may expect a sequence of additional arguments, each containing a value to be used to replace a format specifier in the format string (or a pointer to a storage location, for n). There should be at least as many of these arguments as the number of values specified in the format specifiers. Additional arguments are ignored by the function.</p>
</li>
</ul>
<p><strong>Return Value</strong></p>
<p>On success, the total number of characters written is returned. This count does not include the additional null-character automatically appended at the end of the string. On failure, a negative number is returned.</p>
<h3 id="最终代码"><a href="#最终代码" class="headerlink" title="最终代码"></a>最终代码</h3><h4 id="test-ctypes-c"><a href="#test-ctypes-c" class="headerlink" title="test_ctypes.c"></a>test_ctypes.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wchar.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">void</span> <span class="token function">say_hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello world in C.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">say_time</span><span class="token punctuation">(</span><span class="token class-name">time_t</span><span class="token operator">*</span> timer<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> now<span class="token punctuation">;</span>

    <span class="token comment">// 今天已经过去的时间（秒）</span>
    now <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">long</span> hour <span class="token operator">=</span> now <span class="token operator">/</span> <span class="token number">3600</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> minute <span class="token operator">=</span> now <span class="token operator">%</span> <span class="token number">3600</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> second <span class="token operator">=</span> now <span class="token operator">%</span> <span class="token number">3600</span> <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"零时区时间： %2ld :%2ld :%2ld \n"</span><span class="token punctuation">,</span> hour<span class="token punctuation">,</span> minute<span class="token punctuation">,</span> second<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 北京位于东八区：东八区（UTC/GMT+08:00）是比世界协调时间（UTC）/格林尼治时间（GMT）快 8 小时的时区</span>
    hour <span class="token operator">=</span> <span class="token punctuation">(</span>hour <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">24</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"北京时间：   %2ld :%2ld :%2ld \n"</span><span class="token punctuation">,</span> hour<span class="token punctuation">,</span> minute<span class="token punctuation">,</span> second<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">call_functions</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">,</span> <span class="token class-name">wchar_t</span><span class="token operator">*</span> w_str<span class="token punctuation">,</span> <span class="token keyword">double</span> db<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"int i = %d\nchar* str = %s\nwchar_t* w_str = %ls\ndouble* db = %f\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> str<span class="token punctuation">,</span> w_str<span class="token punctuation">,</span> db<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">say_bottles</span><span class="token punctuation">(</span><span class="token keyword">int</span> bottles<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d bottles of beer.\n"</span><span class="token punctuation">,</span> bottles<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">return_bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">pass_pointers</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> i<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> f<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">sscanf</span><span class="token punctuation">(</span><span class="token string">"1 3.14 Hello"</span><span class="token punctuation">,</span> <span class="token string">"%d %f %s"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> f<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token class-name">cell</span><span class="token punctuation">;</span> <span class="token comment">/* forward declaration */</span>

<span class="token keyword">struct</span> <span class="token class-name">cell</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">cell</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">int</span> NUMBER <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">int</span> array<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">say_array</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>puStr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c "</span><span class="token punctuation">,</span> puStr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">double_point</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span> ppInt<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> ppStr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"before int: %d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>ppInt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token operator">*</span>ppInt <span class="token operator">=</span> <span class="token number">10086</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>ppStr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token operator">*</span>ppStr<span class="token punctuation">,</span> <span class="token string">"Happy National Day!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">free_point</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pt<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pt <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_rect</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> index<span class="token punctuation">;</span>
    <span class="token keyword">char</span> info<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>Rect<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">read_rect</span><span class="token punctuation">(</span>Rect rect<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index: %d info: %s\n"</span><span class="token punctuation">,</span> rect<span class="token punctuation">.</span>index<span class="token punctuation">,</span> rect<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">read_rect_point</span><span class="token punctuation">(</span>Rect <span class="token operator">*</span> pRect<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"index: %d info: %s\n"</span><span class="token punctuation">,</span> pRect<span class="token operator">-></span>index<span class="token punctuation">,</span> pRect<span class="token operator">-></span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">read_rect_array</span><span class="token punctuation">(</span>Rect <span class="token operator">*</span> pRectArray<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pRectArray.index: %d pRectArray.info: %s\n"</span><span class="token punctuation">,</span> pRectArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">,</span> pRectArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

Rect <span class="token operator">*</span> <span class="token function">obtain_rect_array</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span> pArrayNum<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>pArrayNum <span class="token operator">=</span> num<span class="token punctuation">;</span>
    Rect <span class="token operator">*</span>pArray <span class="token operator">=</span> <span class="token punctuation">(</span>Rect<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>num <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Rect<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        pArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>index <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>pArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>info<span class="token punctuation">,</span> <span class="token string">"%s_%d"</span><span class="token punctuation">,</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> pArray<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">free_rect</span><span class="token punctuation">(</span>Rect <span class="token operator">*</span> pRect<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>pRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="test-ctypes-py"><a href="#test-ctypes-py" class="headerlink" title="test_ctypes.py"></a>test_ctypes.py</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> ctypes

<span class="token keyword">def</span> <span class="token function">test_say_hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">(</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>say_hello_world <span class="token operator">==</span> libc<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>libc<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span> <span class="token operator">==</span> libc<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    libc_ll <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc_ll<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">(</span><span class="token punctuation">)</span>

    libc_ll<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>libc_ll<span class="token punctuation">.</span>say_hello_world <span class="token operator">==</span> libc_ll<span class="token punctuation">.</span>say_hello_world<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>libc_ll<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span> <span class="token operator">==</span> libc_ll<span class="token punctuation">[</span><span class="token string">'say_hello_world'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_say_time</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>say_time<span class="token punctuation">(</span>timer<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_fundamental_data_types</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"调用构造函数创建对象："</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_wchar_p<span class="token punctuation">(</span><span class="token string">"Hello, World"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_ushort<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"更改对象的值"</span><span class="token punctuation">)</span>

    i <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    i<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">99</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"c_wchar_p"</span><span class="token punctuation">)</span>

    s <span class="token operator">=</span> <span class="token string">"Hello, World"</span>
    c_s <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_wchar_p<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token comment"># the memory location has changed</span>
    c_s<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">"Hi, there"</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>c_s<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token comment"># first object is unchanged</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"create_string_buffer()"</span><span class="token punctuation">)</span>

    <span class="token comment"># create a 3 byte buffer, initialized to NUL bytes</span>
    p <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># create a buffer containing a NUL terminated string</span>
    p <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token string">b"Hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># create a 10 byte buffer</span>
    p <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token string">b"hello"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">b"Hi"</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_call_functions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    i <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>

    <span class="token builtin">str</span> <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">(</span><span class="token string">b"Hello, World in c_char_p."</span><span class="token punctuation">)</span>

    w_str <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_wchar_p<span class="token punctuation">(</span><span class="token string">"我要成为真正的狐狸精!!!"</span><span class="token punctuation">)</span>

    db <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_double<span class="token punctuation">(</span><span class="token number">3.14</span><span class="token punctuation">)</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>call_functions<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">,</span> w_str<span class="token punctuation">,</span> db<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Bottles</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        self<span class="token punctuation">.</span>_as_parameter_ <span class="token operator">=</span> number

<span class="token keyword">def</span> <span class="token function">test_say_bottles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    bottles <span class="token operator">=</span> Bottles<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>say_bottles<span class="token punctuation">(</span>bottles<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_argtypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>call_functions<span class="token punctuation">.</span>argtypes <span class="token operator">=</span> <span class="token punctuation">[</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_wchar_p<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_double<span class="token punctuation">]</span>

    libc<span class="token punctuation">.</span>call_functions<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">b"Hello, World in c_char_p."</span><span class="token punctuation">,</span> <span class="token string">"我要成为真正的狐狸精!!!"</span><span class="token punctuation">,</span> <span class="token number">3.14</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">valid_return</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token keyword">def</span> <span class="token function">test_return_types</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
    strchr <span class="token operator">=</span> libc<span class="token punctuation">.</span>strchr
    <span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># c_char_p is a pointer to a string</span>
    strchr<span class="token punctuation">.</span>restype <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_char_p
    <span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    strchr<span class="token punctuation">.</span>argtypes <span class="token operator">=</span> <span class="token punctuation">[</span>ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_char<span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token string">b"d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>strchr<span class="token punctuation">(</span><span class="token string">b"abcdef"</span><span class="token punctuation">,</span> <span class="token string">b"x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    return_bool <span class="token operator">=</span> libc<span class="token punctuation">.</span>return_bool
    return_bool<span class="token punctuation">.</span>restype <span class="token operator">=</span> valid_return

    <span class="token keyword">print</span><span class="token punctuation">(</span>return_bool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_pass_pointers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    i <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_float<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>create_string_buffer<span class="token punctuation">(</span><span class="token string">b'\000'</span> <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">,</span> f<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>pass_pointers<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>value<span class="token punctuation">,</span> f<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">POINT</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">RECT</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"upperleft"</span><span class="token punctuation">,</span> POINT<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"lowerright"</span><span class="token punctuation">,</span> POINT<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_structures_unions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    p_1 <span class="token operator">=</span> POINT<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>p_1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p_1<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    p_2 <span class="token operator">=</span> POINT<span class="token punctuation">(</span>y <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>p_2<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p_2<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    rc <span class="token operator">=</span> RECT<span class="token punctuation">(</span>p_1<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    rc_1 <span class="token operator">=</span> RECT<span class="token punctuation">(</span>POINT<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> POINT<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    rc_2 <span class="token operator">=</span> RECT<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>rc_1<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_1<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc_1<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_1<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>rc_2<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_2<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc_2<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc_2<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>POINT<span class="token punctuation">.</span>x<span class="token punctuation">,</span> POINT<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Int</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"first_16"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"second_16"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_bit_fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>Int<span class="token punctuation">.</span>first_16<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>Int<span class="token punctuation">.</span>second_16<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">MyStruct</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_float<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"point_array"</span><span class="token punctuation">,</span> POINT <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_arrays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    TenPointsArrayType <span class="token operator">=</span> POINT <span class="token operator">*</span> <span class="token number">10</span>

    arr <span class="token operator">=</span> TenPointsArrayType<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> pt <span class="token keyword">in</span> arr<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>pt<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pt<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>point_array<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    TenIntegers <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> <span class="token number">10</span>

    ii <span class="token operator">=</span> TenIntegers<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> ii<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_pointers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    i <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
    pi <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>i<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents <span class="token keyword">is</span> i<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents <span class="token keyword">is</span> pi<span class="token punctuation">.</span>contents<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    j <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span>
    pi<span class="token punctuation">.</span>contents <span class="token operator">=</span> j
    <span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span>contents<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>pi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
    pi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">22</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    PI <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>PI<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>PI<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    null_ptr <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">(</span>null_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"values"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_type_conversions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    bar <span class="token operator">=</span> Bar<span class="token punctuation">(</span><span class="token punctuation">)</span>
    bar<span class="token punctuation">.</span>values <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    bar<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">3</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    bar<span class="token punctuation">.</span>values <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    a <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_byte <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>a<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    bar <span class="token operator">=</span> Bar<span class="token punctuation">(</span><span class="token punctuation">)</span>
    b <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_long <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
    bar<span class="token punctuation">.</span>values <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>b<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">cell</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">pass</span>

cell<span class="token punctuation">.</span>_fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"next"</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_incomplete_types</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    c1 <span class="token operator">=</span> cell<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">b"foo"</span>
    
    c2 <span class="token operator">=</span> cell<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c2<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">b"bar"</span>

    c1<span class="token punctuation">.</span><span class="token builtin">next</span> <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>c2<span class="token punctuation">)</span>
    c2<span class="token punctuation">.</span><span class="token builtin">next</span> <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>c1<span class="token punctuation">)</span>

    p<span class="token operator">=</span>c1
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
        p <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">py_cmp_func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"py_cmp_func"</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token decorator annotation punctuation">@ctypes<span class="token punctuation">.</span>CFUNCTYPE</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">py_cmp_reverse</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"py_cmp_reverse"</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_callback_functions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    IntArray5 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> <span class="token number">5</span>
    ia <span class="token operator">=</span> IntArray5<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
    qsort <span class="token operator">=</span> libc<span class="token punctuation">.</span>qsort
    qsort<span class="token punctuation">.</span>restype <span class="token operator">=</span> <span class="token boolean">None</span>

    CMPFUNC <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CFUNCTYPE<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">)</span>
    qsort<span class="token punctuation">(</span>ia<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ia<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> CMPFUNC<span class="token punctuation">(</span>py_cmp_func<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> ia<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    ia_r <span class="token operator">=</span> IntArray5<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>
    qsort<span class="token punctuation">(</span>ia_r<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ia_r<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> py_cmp_reverse<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> ia_r<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_access_values_from_dlls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
    num <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">.</span>in_dll<span class="token punctuation">(</span>libc<span class="token punctuation">,</span> <span class="token string">"NUMBER"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    array <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int <span class="token operator">*</span> num<span class="token punctuation">.</span>value
    table <span class="token operator">=</span> array<span class="token punctuation">.</span>in_dll<span class="token punctuation">(</span>libc<span class="token punctuation">,</span> <span class="token string">"array"</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> item <span class="token keyword">in</span> table<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_surprises</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    p1 <span class="token operator">=</span> POINT<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    p2 <span class="token operator">=</span> POINT<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    rc <span class="token operator">=</span> RECT<span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token comment"># now swap the two points</span>
    rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright <span class="token operator">=</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft
    <span class="token keyword">print</span><span class="token punctuation">(</span>rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>upperleft<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>x<span class="token punctuation">,</span> rc<span class="token punctuation">.</span>lowerright<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    s <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">b"abc def ghi"</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>value <span class="token keyword">is</span> s<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_variable_sized_data_types</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    short_array <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_short <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    ctypes<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>short_array<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>short_array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>short_array<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_from_buffer_copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>
    u_str_info <span class="token operator">=</span> <span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_ubyte <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span>from_buffer_copy<span class="token punctuation">(</span><span class="token string">b'0123456789abcdef'</span><span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>say_array<span class="token punctuation">(</span>u_str_info<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_double_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    int_a <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    int_pt <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>int_a<span class="token punctuation">)</span>
    word_pt <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_char_p<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    libc<span class="token punctuation">.</span>double_point<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>int_pt<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>word_pt<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"out_value: "</span><span class="token punctuation">,</span> int_a<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"out_word: "</span><span class="token punctuation">,</span> word_pt<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>free_point<span class="token punctuation">(</span>word_pt<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Rect</span><span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>

    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_char <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_read_rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    libc <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libtest.so"</span><span class="token punctuation">)</span>

    rect_a <span class="token operator">=</span> Rect<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">b"Hello"</span><span class="token punctuation">)</span>
    
    libc<span class="token punctuation">.</span>read_rect<span class="token punctuation">(</span>rect_a<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>read_rect_point<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>rect_a<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    rect_array <span class="token operator">=</span> <span class="token punctuation">(</span>Rect <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        rect_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Rect<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token string">"Hello_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>read_rect_array<span class="token punctuation">(</span>rect_array<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*"</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span>

    libc<span class="token punctuation">.</span>obtain_rect_array<span class="token punctuation">.</span>restype <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>POINTER<span class="token punctuation">(</span>Rect<span class="token punctuation">)</span>
    num <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rect_pt <span class="token operator">=</span> libc<span class="token punctuation">.</span>obtain_rect_array<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>byref<span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"index: "</span><span class="token punctuation">,</span> rect_pt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">,</span> <span class="token string">"info: "</span><span class="token punctuation">,</span> rect_pt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>info<span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>free_rect<span class="token punctuation">(</span>rect_pt<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    
    <span class="token comment">#test_say_hello_world()</span>

    <span class="token comment">#test_say_time(None)</span>

    <span class="token comment">#test_fundamental_data_types()</span>

    <span class="token comment">#test_call_functions()</span>

    <span class="token comment">#test_say_bottles()</span>

    <span class="token comment">#test_argtypes()</span>

    <span class="token comment">#test_return_types()</span>

    <span class="token comment">#test_pass_pointers()</span>

    <span class="token comment">#test_structures_unions()</span>

    <span class="token comment">#test_bit_fields()</span>

    <span class="token comment">#test_arrays()</span>

    <span class="token comment">#test_pointers()</span>

    <span class="token comment">#test_type_conversions()</span>

    <span class="token comment">#test_incomplete_types()</span>

    <span class="token comment">#test_callback_functions()</span>

    <span class="token comment">#test_access_values_from_dlls()</span>

    <span class="token comment">#test_surprises()</span>

    <span class="token comment">#test_variable_sized_data_types()</span>

    <span class="token comment">#test_from_buffer_copy()</span>

    <span class="token comment">#test_double_point()</span>

    test_read_rect<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>第十六篇博文写完，开心！！！！</p>
<p>今天，也是充满希望的一天。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">LuYF-Lemon-love</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://luyf-lemon-love.space/2022/06/26/00016-ctypes-python-de-wai-bu-han-shu-ku-ubuntu/">https://luyf-lemon-love.space/2022/06/26/00016-ctypes-python-de-wai-bu-han-shu-ku-ubuntu/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">LuYF-Lemon-love</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/C/">
                                    <span class="chip bg-color">C++</span>
                                </a>
                            
                                <a href="/tags/Python/">
                                    <span class="chip bg-color">Python</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">谢谢小主！</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="https://cos.luyf-lemon-love.space/images/20220511162303.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="https://cos.luyf-lemon-love.space/images/20220511162220.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/07/01/00017-li-yong-ctypes-bing-xing-ji-suan-pi-ubuntu/">
                    <div class="card-image">
                        
                        <img src="https://cos.luyf-lemon-love.space/images/20220604154633.png" class="responsive-img" alt="00017-利用ctypes并行计算Pi-ubuntu">
                        
                        <span class="card-title">00017-利用ctypes并行计算Pi-ubuntu</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-07-01
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/C-C-%E5%92%8CPython%E6%B7%B7%E5%90%88%E7%BC%96%E7%A8%8B/" class="post-category">
                                    C/C++和Python混合编程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C/">
                        <span class="chip bg-color">C++</span>
                    </a>
                    
                    <a href="/tags/Python/">
                        <span class="chip bg-color">Python</span>
                    </a>
                    
                    <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">
                        <span class="chip bg-color">多线程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/06/23/00015-c-yu-yan-xian-cheng-chi/">
                    <div class="card-image">
                        
                        <img src="https://cos.luyf-lemon-love.space/images/20220604154519.png" class="responsive-img" alt="00015-C语言线程池">
                        
                        <span class="card-title">00015-C语言线程池</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-06-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/C/" class="post-category">
                                    C++
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/C/">
                        <span class="chip bg-color">C++</span>
                    </a>
                    
                    <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">
                        <span class="chip bg-color">多线程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
    });
</script>



    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2024</span>
            
            <a href="/about" target="_blank">LuYF-Lemon-love</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2022";
                        var startMonth = "5";
                        var startDate = "7";
                        var startHour = "4";
                        var startMinute = "53";
                        var startSecond = "32";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
                <span id="icp"><img src="/medias/icp.png"
                                    style="vertical-align: text-bottom;"/>
                <a href="https://beian.miit.gov.cn" target="_blank">冀ICP备2022012632号-1</a>
            </span>
            
            <br>
            
                <span id="gongan"><img src="https://cos.luyf-lemon-love.space/images/备案图标.png"
                                    style="vertical-align: text-bottom;"/>
                <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=32011502011618" target="_blank">苏公网安备 32011502011618号</a>
            </span>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/LuYF-Lemon-love" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:luyanfeng_nlp@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>');
            }
        </script>
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
